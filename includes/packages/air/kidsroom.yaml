kidsroom_air:
  input_boolean:
    kidsroom_airpurifier_favourite_speed_smart_control:
      name: 'Умное управление скоростью бризера в детской'


  input_number:
    kidsroom_airpurifier_favorite_speed:
      name: 'Установленная скорость бризера в детской'
      min: 60
      max: 150
      step: 1
      icon: mdi:weather-windy


  input_select:
    kidsroom_airpurifier_mode:
      name: 'Режим работы бризера в детской'
      options:
        - Auto
        - Sleep
        - Favorite


  timer:
    kidsroom_airpurifier_fixed_speed:
      name: 'Фиксированная скорость бризера в детской, осталось '
      duration: 1800

    kidsroom_humidifier_fixed_mode:
      name: 'Фиксированный режим увлажнителя в детской, осталось '
      duration: 1800

    kidsroom_airpurifier_heater_remind:
      name: 'Нагреватель бризера в детской включен, напомнить через '
      duration: 3600

    kidsroom_airpurifier_heater:
      name: 'Нагреватель бризера в детской включен, выключение через '
      duration: 10800


  switch:
    - platform: template
      switches:
        kidsroom_airpurifier_display:
          friendly_name: 'Дисплей бризера в детской'
          value_template: '{{ is_state_attr(''fan.mijia_airpurifier_kidsroom'', ''display'', True) }}'
          turn_on:
            service: xiaomi_miio_airpurifier.fan_set_display_on
            entity_id: fan.mijia_airpurifier_kidsroom
          turn_off:
            service: xiaomi_miio_airpurifier.fan_set_display_off
            entity_id: fan.mijia_airpurifier_kidsroom
          icon_template: mdi:lightbulb-outline
        
        kidsroom_airpurifier_buzzer:
          friendly_name: 'Звук бризера в детской'
          value_template: '{{ is_state_attr(''fan.mijia_airpurifier_kidsroom'', ''buzzer'', True) }}'
          turn_on:
            service: xiaomi_miio_airpurifier.fan_set_buzzer_on
            entity_id: fan.mijia_airpurifier_kidsroom
          turn_off:
            service: xiaomi_miio_airpurifier.fan_set_buzzer_off
            entity_id: fan.mijia_airpurifier_kidsroom
          icon_template: mdi:volume-high
        
        kidsroom_airpurifier_ptc:
          friendly_name: 'Нагреватель бризера в детской'
          value_template: '{{ is_state_attr(''fan.mijia_airpurifier_kidsroom'', ''ptc'', True) }}'
          turn_on:
            service: xiaomi_miio_airpurifier.fan_set_ptc_on
            entity_id: fan.mijia_airpurifier_kidsroom
          turn_off:
            service: xiaomi_miio_airpurifier.fan_set_ptc_off
            entity_id: fan.mijia_airpurifier_kidsroom
          icon_template: mdi:fire
        
        kidsroom_airpurifier_forced_ventilation:
          friendly_name: 'Проветривание в детской'
          value_template: >
            {% set favorite_mode = is_state_attr('fan.mijia_airpurifier_kidsroom', 'preset_mode', 'Favorite') %}
            {% set max_speed_flag = states('sensor.kidsroom_airpurifier_favorite_speed') | int(0) == 150 %}
            {% set fixed_speed_timer_on = is_state('timer.kidsroom_airpurifier_fixed_speed', 'active') %}
            {{ favorite_mode and max_speed_flag and fixed_speed_timer_on }}
          turn_on:
            - service: fan.turn_on
              entity_id: fan.mijia_airpurifier_kidsroom
            - service: input_select.select_option
              entity_id: input_select.kidsroom_airpurifier_mode
              data:
                option: 'Favorite'
            - service: input_number.set_value
              entity_id: input_number.kidsroom_airpurifier_favorite_speed
              data:
                value: 150
            - service: timer.start
              entity_id: timer.kidsroom_airpurifier_fixed_speed
          turn_off:
            - service: timer.finish
              entity_id: timer.kidsroom_airpurifier_fixed_speed
          icon_template: mdi:weather-windy
        
        kidsroom_airpurifier_favourite_speed_smart_control:
          friendly_name: 'Умное управление скоростью бризера в детской'
          value_template: >
            {% set favorite_mode = is_state_attr('fan.mijia_airpurifier_kidsroom', 'preset_mode', 'Favorite') %}
            {% set smart_control = is_state('input_boolean.kidsroom_airpurifier_favourite_speed_smart_control', 'on') %}
            {{ favorite_mode and smart_control }}
          turn_on:
            - service: input_boolean.turn_on
              entity_id: input_boolean.kidsroom_airpurifier_favourite_speed_smart_control
          turn_off:
            - service: input_boolean.turn_off
              entity_id: input_boolean.kidsroom_airpurifier_favourite_speed_smart_control
          icon_template: mdi:speedometer
        
        kidsroom_airpurifier_favourite_speed_temporary_fixed:
          friendly_name: 'Фиксированная скорость бризера в детской'
          value_template: >
            {% set favorite_mode = is_state_attr('fan.mijia_airpurifier_kidsroom', 'preset_mode', 'Favorite') %}
            {% set smart_control = is_state('switch.kidsroom_airpurifier_favourite_speed_smart_control', 'on') %}
            {% set fixed_speed_timer_on = is_state('timer.kidsroom_airpurifier_fixed_speed', 'active') %}
            {{ favorite_mode and smart_control and fixed_speed_timer_on }}
          turn_on:
            - service: timer.start
              entity_id: timer.kidsroom_airpurifier_fixed_speed
          turn_off:
            - service: timer.finish
              entity_id: timer.kidsroom_airpurifier_fixed_speed
          icon_template: mdi:speedometer
  
  
  sensor:
    - platform: template
      sensors:
        kidsroom_airpurifier_co2:
          friendly_name: 'Mi Fresh Air Kidsroom CO²'
          device_class: carbon_dioxide
          unit_of_measurement: 'ppm'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''co2'') }}'
          icon_template: mdi:molecule-co2
        
        kidsroom_airpurifier_pm25:
          friendly_name: 'Mi Fresh Air Kidsroom PM2.5'
          device_class: pm25
          unit_of_measurement: 'µg/m³'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''pm25'') }}'
          icon_template: mdi:grain
        
        kidsroom_airpurifier_temperature:
          friendly_name: 'Mi Fresh Air Kidsroom Температура'
          device_class: temperature
          unit_of_measurement: '°C'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''temperature'') }}'
          icon_template: mdi:thermometer
        
        kidsroom_airpurifier_current_speed:
          friendly_name: 'Mi Fresh Air Kidsroom Текущая скорость'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''control_speed'') }}'
          icon_template: mdi:speedometer
        
        kidsroom_airpurifier_favorite_speed:
          friendly_name: 'Mi Fresh Air Kidsroom Установленная скорость'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''favorite_speed'') }}'
          icon_template: mdi:speedometer
        
        kidsroom_airpurifier_dust_filter_life_remaining:
          friendly_name: 'Mi Fresh Air Kidsroom Состояние фильтра'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''dust_filter_life_remaining'') }}'
          unit_of_measurement: '%'
          icon_template: mdi:air-filter
        
        kidsroom_airpurifier_dust_filter_life_remaining_days:
          friendly_name: 'Mi Fresh Air Kidsroom Дней до замены фильтра'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''dust_filter_life_remaining_days'') }}'
          icon_template: mdi:air-filter
        
        kidsroom_airpurifier_preset_mode:
          friendly_name: 'Mi Fresh Air Kidsroom Режим работы'
          value_template: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''preset_mode'') }}'
        
        kidsroom_airpurifier_speed_min_co2:
          value_template:  >
            {% set temp_delta = max(0, 22 - states('sensor.kidsroom_average_temperature') | float) %}
            {% set shift_steps = temp_delta * 100 // 10 %}
            {% if states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 60 %}
              0
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 70 %}
              {{ 600 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 80 %}
              {{ 650 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 90 %}
              {{ 700 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 100 %}
              {{ 800 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 120 %}
              {{ 900 + 10 * shift_steps }}
            {% else %}
              1200
            {% endif %}
          availability_template: >
            {% set valid_speed = states('sensor.kidsroom_airpurifier_favorite_speed') | float(0) >= 60 %}
            {% set valid_temp = states('sensor.kidsroom_average_temperature') | float(0) > 0 %}
            {{ valid_speed and valid_temp }}
        
        kidsroom_airpurifier_speed_max_co2:
          value_template:  >
            {% set temp_delta = max(0, 22 - states('sensor.kidsroom_average_temperature') | float) %}
            {% set cooling_on = is_state('climate.kidsroom_ac', 'cool') | int %}
            {% set shift_steps = temp_delta * 100 // 10 + 15 * cooling_on %}
            {% if states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 60 %}
              {{ 600 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 70 %}
              {{ 650 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 80 %}
              {{ 700 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 90 %}
              {{ 800 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 100 %}
              {{ 900 + 10 * shift_steps }}
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 120 %}
              1200
            {% else %}
              5000
            {% endif %}
          availability_template: >
            {% set valid_speed = states('sensor.kidsroom_airpurifier_favorite_speed') | float(0) >= 60 %}
            {% set valid_temp = states('sensor.kidsroom_average_temperature') | float(0) > 0 %}
            {{ valid_speed and valid_temp }}
        
        kidsroom_airpurifier_next_speed:
          value_template:  >
            {% if states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 60 %}
              70
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 70 %}
              80
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 80 %}
              90
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 90 %}
              100
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 100 %}
              120
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 120 %}
              150
            {% else %}
              150
            {% endif %}
          availability_template: 'states(''sensor.kidsroom_airpurifier_favorite_speed'') | float(0) >= 60'
        
        kidsroom_airpurifier_previous_speed:
          value_template:  >
            {% if states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 70 %}
              60
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 80 %}
              70
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 90 %}
              80
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 100 %}
              90
            {% elif states('sensor.kidsroom_airpurifier_favorite_speed') | float <= 120 %}
              100
            {% else %}
              120
            {% endif %}
          availability_template: 'states(''sensor.kidsroom_airpurifier_favorite_speed'') | float(0) >= 60'
        
        kidsroom_airpurifier_favourite_speed_needs_changes:
          value_template: >
            {% set hi = (states('sensor.kidsroom_airpurifier_speed_max_co2') | float) + 15 %}
            {% set lo = (states('sensor.kidsroom_airpurifier_speed_min_co2') | float) - 35 %}
            {% set co2 = states('sensor.cleargrass_air_co2') | float %}
            {% if co2 > hi %}
              up
            {% elif co2 < lo %}
              down
            {% else %}
              keep
            {% endif %}
          availability_template: >
            {% set valid_min_co2 = states('sensor.kidsroom_airpurifier_speed_min_co2') | float(-1) >= 0 %}
            {% set valid_max_co2 = states('sensor.kidsroom_airpurifier_speed_max_co2') | float(-1) >= 0 %}
            {% set valid_co2 = states('sensor.cleargrass_air_co2') | float(0) > 0 %}
            {{ valid_min_co2 and valid_max_co2 and valid_co2 }}
  
  
  binary_sensor:
    - platform: template
      sensors:
        kidsroom_airpurifier_ptc_status:
          friendly_name: 'Статус нагревателя бризера в детской'
          device_class: heat
          value_template: '{{ is_state_attr(''fan.mijia_airpurifier_kidsroom'', ''ptc_status'', True) }}'
        
        kidsroom_airpurifier_favourite_speed_fixed:
          friendly_name: 'Фиксированная скорость бризера в детской'
          value_template: >
            {% set smart_control_off = is_state('switch.kidsroom_airpurifier_favourite_speed_smart_control', 'off') %}
            {% set tmp_fixed_speed = is_state('switch.kidsroom_airpurifier_favourite_speed_temporary_fixed', 'on') %}
            {{ smart_control_off or tmp_fixed_speed }}
  
  
  automation:
    - id: 'Выбор режима работы бризера в детской'
      alias: select_kidsroom_airpurifier_preset_mode
      trigger:
        - entity_id: input_select.kidsroom_airpurifier_mode
          platform: state
      action:
        - service: fan.set_preset_mode
          entity_id: fan.mijia_airpurifier_kidsroom
          data_template:
            preset_mode: '{{ states(''input_select.kidsroom_airpurifier_mode'') }}'
    
    - id: 'Отслеживание режима работы бризера в детской'
      alias: tracking_kidsroom_airpurifier_preset_mode
      trigger:
        - platform: state
          entity_id: sensor.kidsroom_airpurifier_preset_mode
      action:
        - service: input_select.select_option
          entity_id: input_select.kidsroom_airpurifier_mode
          data_template:
            option: >
              {% if state_attr('fan.mijia_airpurifier_kidsroom', 'preset_mode') %}
                {{ state_attr('fan.mijia_airpurifier_kidsroom', 'preset_mode') }}
              {% else %}
                Auto
              {% endif %}
    
    - id: 'Выбор скорости потока воздуха для бризера в детской'
      alias: select_kidsroom_airpurifier_speed
      trigger:
        - platform: state
          entity_id: input_number.kidsroom_airpurifier_favorite_speed
      action:
        - service: xiaomi_miio_airpurifier.fan_set_favorite_speed
          entity_id: fan.mijia_airpurifier_kidsroom
          data_template:
            speed: '{{ states(''input_number.kidsroom_airpurifier_favorite_speed'') | int }}'
    
    - id: 'Отслеживание скорости потока воздуха для бризера в детской'
      alias: tracking_kidsroom_airpurifier_speed
      trigger:
        - platform: state
          entity_id: sensor.kidsroom_airpurifier_favorite_speed
      action:
        - service: input_number.set_value
          entity_id: input_number.kidsroom_airpurifier_favorite_speed
          data_template:
            value: '{{ state_attr(''fan.mijia_airpurifier_kidsroom'', ''favorite_speed'') }}'
    
    - id: 'Умный контроль скорости работы бризера в детской'
      alias: kidsroom_airpurifier_favourite_speed_smart_control
      initial_state: true
      trigger:
        - platform: time_pattern
          minutes: '/2'
      condition:
        - alias: kidsroom_airpurifier_favourite_speed_does_need_changes
          condition: not
          conditions:
            - condition: state
              entity_id: sensor.kidsroom_airpurifier_favourite_speed_needs_changes
              state: 'keep'
        - condition: state
          entity_id: switch.kidsroom_airpurifier_favourite_speed_smart_control
          state: 'on'
        - condition: state
          entity_id: switch.kidsroom_airpurifier_favourite_speed_temporary_fixed
          state: 'off'
        - condition: template
          value_template: >
            {% set prev_speed_valid = states('sensor.kidsroom_airpurifier_previous_speed') | int(0) > 0 %}
            {% set next_speed_valid = states('sensor.kidsroom_airpurifier_previous_speed') | int(0) > 0 %}
            {{ prev_speed_valid and next_speed_valid }}
      action:
        - service: input_number.set_value
          entity_id: input_number.kidsroom_airpurifier_favorite_speed
          data_template:
            value: >
              {% if is_state('sensor.kidsroom_airpurifier_favourite_speed_needs_changes', 'up') %}
                {{ states('sensor.kidsroom_airpurifier_next_speed') | int }}
              {% else %}
                {{ states('sensor.kidsroom_airpurifier_previous_speed') | int }}
              {% endif %}
    
    - id: 'Включение таймеров нагревателя бризера в детской'
      alias: kidsroom_airpurifier_heater_timers_start
      initial_state: true
      trigger:
        - platform: state
          entity_id: switch.kidsroom_airpurifier_ptc
          to: 'on'
        - platform: homeassistant
          event: start
      condition:
        - condition: state
          entity_id: switch.kidsroom_airpurifier_ptc
          state: 'on'
      action:
        - service: timer.start
          entity_id:
            - timer.kidsroom_airpurifier_heater
            - timer.kidsroom_airpurifier_heater_remind
    
    - id: 'Включен нагреватель бризера в детской - уведомление'
      alias: kidsroom_airpurifier_heater_on_reminder
      initial_state: true
      trigger:
        - platform: state
          entity_id: timer.kidsroom_airpurifier_heater_remind
          from: 'active'
          to: 'idle'
        - platform: homeassistant
          event: start
      condition:
        - condition: state
          entity_id: switch.kidsroom_airpurifier_ptc
          state: 'on'
      action:
        - service: notify.tg
          data:
            message: >
              {% set messages = ['Нагреватель бризера в детской все еще работает!',
                                 'Бризер в детской продолжает греть воздух..',
                                 'Нагреватель бризера в детской еще жарит!'] %}
              {{ '\U0001F525' }} {{ messages | random }} {{ states('sensor.time_date') }}
        - service: timer.start
          entity_id: timer.kidsroom_airpurifier_heater_remind
    
    - id: 'Выключение нагревателя бризера в детской'
      alias: kidsroom_airpurifier_heater_timed_turn_off
      initial_state: true
      trigger:
        - platform: state
          entity_id: timer.kidsroom_airpurifier_heater
          from: 'active'
          to: 'idle'
      condition:
        - condition: state
          entity_id: switch.kidsroom_airpurifier_ptc
          state: 'on'
      action:
        - service: switch.turn_off
          entity_id: switch.kidsroom_airpurifier_ptc
        - service: notify.tg
          data:
            message: >
              {% set messages = ['Нагреватель бризера в детской выключен!',
                                 'Бризер в детской завершает греть воздух..',
                                 'Нагреватель бризера в детской покидает здание!'] %}
              {{ '\U0001F9EF' }} {{ messages | random }} {{ states('sensor.time_date') }}
        - service: timer.finish
          entity_id: timer.kidsroom_airpurifier_heater_remind
    
    - id: 'Выключение таймеров нагревателя бризера в детской'
      alias: kidsroom_airpurifier_heater_timers_turn_off
      initial_state: true
      trigger:
        - platform: state
          entity_id: switch.kidsroom_airpurifier_ptc
          to: 'off'
      action:
        - service: timer.finish
          entity_id:
            - timer.kidsroom_airpurifier_heater_remind
            - timer.kidsroom_airpurifier_heater
