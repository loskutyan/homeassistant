cubeserver:
  sensor:
    - platform: template
      sensors:
        cubeserver_ip:
          friendly_name: 'Cubeserver IP'
          value_template: !secret cubeserver_ip
  
  
  binary_sensor:
    - platform: ping
      name: cubeserver_vm_windows10_ping
      host: !secret cubeserver_windows10_vm_ip
      scan_interval: 20
      count: 2
    
    - platform: command_line
      name: cubeserver_vm_windows10_virsh_status
      command: 'if test $(ssh -i /config/cubeserver.key -o StrictHostKeyChecking=no root@{{ states(''sensor.cubeserver_ip'') }} virsh list --all | grep ''Windows 10'' | awk ''{print $4}'') == running; then echo running; else echo ''not running''; fi'
      device_class: connectivity
      payload_on: 'running'
      payload_off: 'not running'
  
  
  shell_command:
    run_cubeserver_vm_windows10: 'ssh -i /config/cubeserver.key -o StrictHostKeyChecking=no root@{{ states(''sensor.cubeserver_ip'') }} virsh start ''Windows\ 10'''
    shutdown_cubeserver_vm_windows10: 'ssh -i /config/cubeserver.key -o StrictHostKeyChecking=no root@{{ states(''sensor.cubeserver_ip'') }} virsh shutdown ''Windows\ 10'''
  
  
  script:
    shutdown_cubeserver_vm_windows10:
      alias: 'cubeserver: выключение VM Windows 10'
      sequence:
        service:
          shell_command.shutdown_cubeserver_vm_windows10
  
  
  switch:
    - platform: template
      switches:
        cubeserver_vm_windows10:
          friendly_name: 'VM Windows 10'
          value_template: >
            {% set ping_status = states('binary_sensor.cubeserver_vm_windows10_ping') %}
            {% set virsh_status = states('binary_sensor.cubeserver_vm_windows10_virsh_status') %}
            {{ ping_status and virsh_status }}
          turn_on:
            service: shell_command.run_cubeserver_vm_windows10
          turn_off:
            service: shell_command.shutdown_cubeserver_vm_windows10
          icon_template: mdi:desktop-classic
