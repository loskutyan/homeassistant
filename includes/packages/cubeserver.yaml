cuberserver:
  binary_sensor:
    - platform: ping
      name: cuberserver_vm_windows10_ping
      host: 192.168.1.240
      scan_interval: 20
      count: 2
    
    - platform: command_line
      name: cuberserver_vm_windows10_virsh_status
      command: 'if test $(ssh -i /config/cubeserver.key -o StrictHostKeyChecking=no root@192.168.1.10 virsh list --all | grep ''Windows 10'' | awk ''{print $4}'') == running; then echo running; else echo ''not running''; fi'
      device_class: connectivity
      payload_on: 'running'
      payload_off: 'not running'
  
  
  shell_command:
    run_cuberserver_vm_windows10: 'ssh -i /config/cubeserver.key -o StrictHostKeyChecking=no root@192.168.1.10 virsh start ''Windows\ 10'''
    shutdown_cuberserver_vm_windows10: 'ssh -i /config/cubeserver.key -o StrictHostKeyChecking=no root@192.168.1.10 virsh shutdown ''Windows\ 10'''
  
  
  script:
    shutdown_cuberserver_vm_windows10:
      alias: 'cuberserver: выключение VM Windows 10'
      sequence:
        service:
          shell_command.shutdown_cuberserver_vm_windows10
  
  
  switch:
    - platform: template
      switches:
        cuberserver_vm_windows10:
          friendly_name: 'VM Windows 10'
          value_template: >
            {% set ping_status = states('binary_sensor.cuberserver_vm_windows10_ping') %}
            {% set virsh_status = states('binary_sensor.cuberserver_vm_windows10_virsh_status') %}
            {{ ping_status and virsh_status }}
          turn_on:
            service: shell_command.run_cuberserver_vm_windows10
          turn_off:
            service: shell_command.shutdown_cuberserver_vm_windows10
          icon_template: mdi:desktop-classic
