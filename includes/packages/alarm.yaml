alarm:
  binary_sensor:
    - platform: template
      sensors:
        water_leak_detected:
          friendly_name: 'Обнаружена протечка'
          value_template: >
            {% set bathroom = states('binary_sensor.bathroom_aqara_leak_sensor_water_leak') %}
            {% set washing_machine = states('binary_sensor.washing_machine_aqara_leak_sensor_water_leak') %}
            {% set dishwasher = states('binary_sensor.dishwasher_aqara_leak_sensor_water_leak') %}
            {{ bathroom or washing_machine or dishwasher }}
          device_class: moisture
          icon_template: mdi:water-alert
  
  
  alert:
    water_leak_detected:
      name: 'Протечка воды'
      entity_id: binary_sensor.water_leak_detected
      state: 'on'
      message: >
        {% set leakage_sensors = [
          'binary_sensor.bathroom_aqara_leak_sensor_water_leak',
          'binary_sensor.washing_machine_aqara_leak_sensor_water_leak'
          'binary_sensor.dishwasher_aqara_leak_sensor_water_leak'
        ] %}
        {{ '\U0001F30A' }} Протечка воды: {{ states | selectattr('entity_id','in', leakage_sensors)
                                                    | selectattr('state', 'eq', 'on')
                                                    | map(attribute='name')
                                                    | join(', ')
                                                    | lower }}
      done_message: '{{ ''\U0001F3DC'' }} Протечка воды устранена'
      repeat: 5
      can_acknowledge: true
      notifiers:
        - tg
    
    fridge_door_left_opened:
      name: 'Дверь холодильника не закрыта'
      entity_id: binary_sensor.kholodilno_morozilnaia_kombinatsiia_door
      state: 'on'
      repeat: 5
      skip_first: true
      message: >
        {{ '\U00002744' }} Дверь холодильника не закрыта!
      notifiers:
        - tg
  
  
  automation:
    - id: 'Протечка воды'
      alias: water_leak_detected_alarm
      trigger:
        - platform: state
          entity_id: binary_sensor.bathroom_aqara_leak_sensor_water_leak
          to: 'on'
        - platform: state
          entity_id: binary_sensor.washing_machine_aqara_leak_sensor_water_leak
          to: 'on'
        - platform: state
          entity_id: binary_sensor.dishwasher_aqara_leak_sensor_water_leak
          to: 'on'
      action:
        - service: alarm_control_panel.alarm_trigger
          entity_id: alarm_control_panel.miio_gateway
