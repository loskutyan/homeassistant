sleep_time:
  input_boolean:
    kidsroom_asleep:
      name: 'В детской спят'

    bedroom_asleep:
      name: 'В спальне спят'


  switch:
    - platform: template
      switches:
        kidsroom_asleep:
          friendly_name: 'В детской спят'
          value_template: >
            {{ states('input_boolean.kidsroom_asleep') }}
          turn_on:
            service: input_boolean.turn_on
            entity_id: input_boolean.kidsroom_asleep
          turn_off:
            service: input_boolean.turn_off
            entity_id: input_boolean.kidsroom_asleep
          icon_template: >
            {% if is_state('input_boolean.kidsroom_asleep', 'on') %}
              mdi:bed
            {% else %}
              mdi:human-child
            {% endif %}

    - platform: template
      switches:
        bedroom_asleep:
          friendly_name: 'В спальне спят'
          value_template: >
            {{ states('input_boolean.bedroom_asleep') }}
          turn_on:
            service: input_boolean.turn_on
            entity_id: input_boolean.bedroom_asleep
          turn_off:
            service: input_boolean.turn_off
            entity_id: input_boolean.bedroom_asleep
          icon_template: >
            {% if is_state('input_boolean.bedroom_asleep', 'on') %}
              mdi:bed-king
            {% else %}
              mdi:human
            {% endif %}


  automation:
    - id: 'Отход ко сну в детской'
      alias: kidsroom_going_to_sleep
      initial_state: true
      trigger:
        - platform: state
          entity_id: sensor.kidsroom_lights_common_switch_action
          to: 'double_right'
        - platform: state
          entity_id: sensor.kidsroom_aqara_button_action
          to: 'hold'
      condition:
        - condition: state
          entity_id: input_boolean.kidsroom_asleep
          state: 'off'
      action:
        - service: switch.turn_off
          entity_id: switch.kidsroom_lights_common_switch_left
          continue_on_error: true
        - service: light.turn_off
          entity_id: light.kidsroom_wall_aqara_led_bulbs
          continue_on_error: true
        
        - service: input_select.select_option
          entity_id: input_select.kidsroom_airpurifier_mode
          data:
            option: 'Favorite'
          continue_on_error: true
        - service: timer.start
          entity_id: timer.kidsroom_airpurifier_fixed_speed
        - service: input_number.set_value
          entity_id: input_number.kidsroom_airpurifier_favorite_speed
          data:
            value: 60
          continue_on_error: true

        - service: humidifier.set_mode
          entity_id: humidifier.smartmi_humidifier_kidsroom
          data:
            mode: 'Silent'
          continue_on_error: true
        - service: timer.start
          entity_id: timer.kidsroom_humidifier_fixed_mode
          continue_on_error: true

        - service: cover.close_cover
          entity_id: cover.kidsroom_curtain
          continue_on_error: true

        - service: switch.turn_on
          entity_id: switch.kidsroom_nightlight_plug
          continue_on_error: true

        - service: input_boolean.turn_on
          entity_id: input_boolean.kidsroom_asleep

    - id: 'В детской уже не спят'
      alias: kidsroom_supposed_to_wake_up
      initial_state: true
      trigger:
        - platform: time
          at: '09:30'
        - platform: state
          entity_id: sensor.kidsroom_lights_common_switch_action
          to: 'double_right'
        - platform: state
          entity_id: sensor.kidsroom_aqara_button_action
          to: 'hold'
      condition:
        - condition: state
          entity_id: input_boolean.kidsroom_asleep
          state: 'on'
      action:
        - service: input_boolean.turn_off
          entity_id: input_boolean.kidsroom_asleep
        - service: switch.turn_off
          entity_id: switch.kidsroom_nightlight_plug
          continue_on_error: true
        - service: cover.stop_cover
          entity_id: cover.kidsroom_curtain
        - delay: 00:00:05
        - service: cover.open_cover
          entity_id: cover.kidsroom_curtain

    - id: 'Отход ко сну в спальне'
      alias: bedroom_going_to_sleep
      initial_state: true
      trigger:
        - platform: state
          entity_id: sensor.bedroom_aqara_cube_action
          to: 'flip180'
      condition:
        - condition: state
          entity_id: input_boolean.bedroom_asleep
          state: 'off'
      action:
        - service: light.turn_off
          entity_id: light.bedroom_aqara_led_bulb
          data:
            transition: 1
          continue_on_error: true
        - service: switch.turn_off
          entity_id: switch.bedroom_lights_switch_right
          continue_on_error: true

        - service: input_select.select_option
          entity_id: input_select.bedroom_airpurifier_mode
          data:
            option: 'Favorite'
          continue_on_error: true
        - service: timer.start
          entity_id: timer.bedroom_airpurifier_fixed_speed
          continue_on_error: true
        - service: input_number.set_value
          entity_id: input_number.bedroom_airpurifier_favorite_speed
          data:
            value: 60
          continue_on_error: true

        - service: humidifier.set_mode
          entity_id: humidifier.smartmi_humidifier_bedroom
          data:
            mode: 'Silent'
          continue_on_error: true
        - service: timer.start
          entity_id: timer.bedroom_humidifier_fixed_mode
          continue_on_error: true

        - service: input_boolean.turn_on
          entity_id: input_boolean.bedroom_asleep

    - id: 'В спальне уже не спят'
      alias: bedroom_supposed_to_wake_up
      initial_state: true
      trigger:
        - platform: time
          at: '09:30'
        - platform: state
          entity_id: sensor.bedroom_aqara_cube_action
          to: 'flip180'
      condition:
        - condition: state
          entity_id: input_boolean.bedroom_asleep
          state: 'on'
      action:
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_asleep
