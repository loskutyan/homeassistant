hallway_lights:
  automation:
    - id: 'Дверь в прихожей открылась'
      alias: hallway_door_was_opened
      initial_state: true
      trigger:
        - platform: state
          entity_id: binary_sensor.hallway_door_sensor_contact
          to: 'on'
      condition:
        - condition: state
          entity_id: timer.hallway_door_time_to_close
          state: 'idle'
      action:
        - service: notify.tg
          data:
            message: >
              {% set messages = ['Входная дверь открыта в',
                                 'Распахнули входную дверь, а сейчас',
                                 'Кто-то открыл входную дверь в'] %}
              {{ '\U0001F6AA' }} {{ messages | random }} {{ states('sensor.time_date') }}
        - service: timer.start
          entity_id: timer.hallway_door_left_opened
        - service: timer.start
          entity_id: timer.hallway_door_time_to_close
          
    - id: 'Проверка закрытия двери'
      alias: hallway_door_was_closed_check
      initial_state: true
      trigger:
        - platform: state
          entity_id: timer.hallway_door_left_opened
          from: 'active'
          to: 'idle'
      condition:
        - condition: state
          entity_id: binary_sensor.hallway_door_sensor_contact
          state: 'on'
      action:
        - service: notify.tg
          data:
            message: >
              {% set messages = ['входная дверь все еще открыта!',
                                 'не забыли закрыть входную дверь?',
                                 'CLOSE THE DOOR!!!11',
                                 'входную дверь может стоить закрыть?..'] %}
              {{ '\U0001F6AA' }} {{ states('sensor.time') }} - {{ messages | random }}
        - service: timer.start
          entity_id: timer.hallway_door_left_opened
    
    - id: 'Свет при движении в прихожей'
      alias: hallway_motion_lights_turn_on
      initial_state: true
      trigger:
        - platform: state
          entity_id: binary_sensor.hallway_motion_sensor_occupancy
          to: 'on'
        - platform: state
          entity_id: binary_sensor.hallway_door_sensor_contact
          to: 'on'
      condition:
        - condition: numeric_state
          entity_id: sensor.hallway_motion_sensor_illuminance_lux
          below: 100
        - condition: state
          entity_id: switch.hallway_lights_switch
          state: 'off'
      action:
        - service: switch.turn_on
          entity_id: switch.hallway_lights_switch
    
    - id: 'Включение таймера выключения света в прихожей'
      alias: hallway_lights_on_timer_start
      initial_state: true
      trigger:
        - platform: state
          entity_id: switch.hallway_lights_switch
          to: 'on'
      action:
        - service: timer.start
          entity_id: timer.hallway_lights_turn_off_without_motion
    
    - id: 'Выключение таймера выключения света в прихожей'
      alias: hallway_lights_on_timer_finish
      initial_state: true
      trigger:
        - platform: state
          entity_id: switch.hallway_lights_switch
          from: 'on'
          to: 'off'
      action:
        - service: timer.finish
          entity_id: timer.hallway_lights_turn_off_without_motion
    
    - id: 'Сброс таймера выключения света при движении в прихожей'
      alias: hallway_motion_lights_timer_reset
      initial_state: true
      trigger:
        - platform: state
          entity_id: binary_sensor.hallway_motion_sensor_occupancy
          to: 'on'
      condition:
        - condition: state
          entity_id: timer.hallway_lights_turn_off_without_motion
          state: 'active'
      action:
        - service: timer.start
          entity_id: timer.hallway_lights_turn_off_without_motion
    
    - id: 'Сброс таймера выключения света после окончания при движении в прихожей'
      alias: kitchen_motion_timer_finished_lights_timer_reset
      initial_state: true
      trigger:
        - platform: state
          entity_id: timer.hallway_lights_turn_off_without_motion
          from: 'active'
          to: 'idle'
      condition:
        - condition: state
          entity_id: binary_sensor.hallway_motion_sensor_occupancy
          state: 'on'
      action:
        - service: timer.start
          entity_id: timer.hallway_lights_turn_off_without_motion
    
    - id: 'Выключение света в прихожей, если нет движения'
      alias: hallway_no_motion_lights_turn_off
      initial_state: true
      trigger:
        - platform: state
          entity_id: timer.hallway_lights_turn_off_without_motion
          from: 'active'
          to: 'idle'
      condition:
        - condition: state
          entity_id: switch.hallway_lights_switch
          state: 'on'
        - condition: state
          entity_id: binary_sensor.hallway_motion_sensor_occupancy
          state: 'off'
      action:
        - service: switch.turn_off
          entity_id: switch.hallway_lights_switch
    
